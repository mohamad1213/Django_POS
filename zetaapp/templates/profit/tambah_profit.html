{% extends 'base.html' %}{% load static %}
{% load sass_tags %}
{% block css %}
<!-- Plugins css start-->
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/scrollbar.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/owlcarousel.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/rating.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/sweetalert2.scss' %}">

<!-- Plugins css Ends-->
{% endblock css %}
{% block content %}
<div class="page-body">
    {% include 'layout/breadcrumb.html' %}
    {% include 'messages.html' %}
    <!-- Container-fluid starts-->
    <div class="container-fluid list-products">
        <div class="row">
            <!-- Individual column searching (text inputs) Starts-->
            <div class="col-sm-12">
                <div class="card">
                    <div class="card-header pb-0">
                        <div class="order-place" style="text-align: right;">
                            <h4>Formulir Profit</h4>
                        </div>
                    </div>
                    <div class="card-body">
                        <form method="POST" class="form theme-form" enctype="multipart/form-data">
                            {% csrf_token %}
                            {% load crispy_forms_tags %}

                            <div class="row g-3">

                                <div class="col-md-6">
                                    <label class="form-label">Nama Barang</label>
                                    {{ form.nama_barang}}
                                </div>

                                <!-- Harga Beli & Harga Jual -->
                                <div class="col-md-6">
                                    <label class="form-label">Harga Beli</label>
                                    {{ form.harga_beli }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Harga Jual</label>
                                    {{ form.harga_jual }}
                                </div>

                                <!-- Biaya Operasional: 2 kolom -->
                                <h4 class="col-12 mt-3">Biaya Operasional</h4>

                                <div class="col-md-6">
                                    <label class="form-label">Solar</label>
                                    {{ form.solar }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Karung</label>
                                    {{ form.karung }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ongkos Kirim</label>
                                    {{ form.ongkos_kirim }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ongkos Muat</label>
                                    {{ form.ongkos_muat }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ongkos Lain</label>
                                    {{ form.ongkos_lain }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ongkos Sortir</label>
                                    {{ form.ongkos_sortir }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ongkos Giling</label>
                                    {{ form.ongkos_giling }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Biaya Darurat Mesin</label>
                                    {{ form.biaya_darurat_mesin }}
                                </div>

                                <!-- Keterangan full width -->
                                <div class="col-12">
                                    <label class="form-label">Keterangan</label>
                                    {{ form.keterangan}}
                                </div>

                                <!-- HPP / Profit live -->
                                <h4 class="col-12 mt-3">Hasil Kalkulasi</h4>
                                <div class="col-md-4">
                                    <label class="form-label">HPP</label>
                                    <input type="text" id="id_hpp" class="form-control" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Profit</label>
                                    <input type="text" id="id_profit" class="form-control" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Profit Margin (%)</label>
                                    <input type="text" id="id_profit_margin" class="form-control" readonly>
                                </div>

                                <!-- Error -->
                                {% if form.errors %}
                                <div class="col-12">
                                    <div class="alert alert-danger">
                                        {{ form.errors }}
                                    </div>
                                </div>
                                {% endif %}

                                <!-- Submit -->
                                <div class="col-12 text-end">
                                    <button type="reset" class="btn btn-secondary me-2">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Simpan</button>
                                </div>

                            </div> <!-- end row -->
                        </form>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS Live Kalkulasi -->
<script>
    function parseRupiah(value) {
        return parseInt(value.replace(/[^0-9]/g, '')) || 0;
    }
    function formatRupiah(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    function hitungProfit() {
        let harga_beli = parseRupiah(document.getElementById('id_harga_beli').value);
        let harga_jual = parseRupiah(document.getElementById('id_harga_jual').value);

        let biayaElems = document.querySelectorAll('#id_solar, #id_karung, #id_ongkos_kirim, #id_ongkos_muat, #id_ongkos_lain, #id_ongkos_sortir, #id_ongkos_giling, #id_biaya_darurat_mesin');
        let total_biaya_operasional = 0;
        biayaElems.forEach(el => {
            total_biaya_operasional += parseRupiah(el.value);
        });

        let hpp = harga_beli + total_biaya_operasional;
        let profit = harga_jual - hpp;
        let profit_margin = harga_jual ? (profit / harga_jual * 100).toFixed(2) : 0;

        document.getElementById('id_hpp').value = 'Rp ' + formatRupiah(hpp);
        document.getElementById('id_profit').value = 'Rp ' + formatRupiah(profit);
        document.getElementById('id_profit_margin').value = profit_margin + ' %';
    }

    // Live calculation saat input biaya/harga
    document.querySelectorAll('#id_harga_beli, #id_harga_jual, #id_solar, #id_karung, #id_ongkos_kirim, #id_ongkos_muat, #id_ongkos_lain, #id_ongkos_sortir, #id_ongkos_giling, #id_biaya_darurat_mesin').forEach(el => {
        el.addEventListener('input', hitungProfit);
    });
    window.addEventListener('DOMContentLoaded', hitungProfit);
</script>

{% endblock %}