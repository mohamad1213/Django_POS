{% extends 'base.html' %}{% load static %}
{% load sass_tags %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/scrollbar.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/datatables.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/owlcarousel.scss' %}">
<link rel="stylesheet" type="text/css" href="{% sass_src 'assets/scss/vendors/rating.scss' %}">
<!--Favicon-->
<link rel="icon" type="image/png" href="{% static 'favicon.png' %}" />
<!-- Font Awesome 6 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<link href="{% static 'assets2/vendor/datatables/dataTables.bootstrap4.min.css ' %}" rel="stylesheet">
<!--Select2 CSS-->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
<!--Bootstrap Touchspin-->
<link rel="stylesheet"
    href="{% static 'assets2/assets/bootstrap-touchspin-master/src/jquery.bootstrap-touchspin.css' %}">
{% endblock css %}
{% block content %}
<div class="page-body">
    {% include 'layout/breadcrumb.html' %}
    {% if messages %}
    <div class="mt-3">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show"
            role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Container-fluid starts-->
    <div class="container-fluid">
        <form action="{% url 'sales:sales_add' %}" class="saleForm" method="post">
            <div class="row">
                <div class="card shadow col-12">
                    <div class="card-body ml-0">
                        <div class="row">

                            <div class="col-12 col-md-9">
                                <div class="row">
                                    <div class="card"
                                        style="border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); background-color: #508C9B;">
                                        <div class="card-body">
                                            <div class="col-12">
                                                <div class="form-group">
                                                    <div class="input-group">
                                                        <select class="form-control select2" name="searchbox_products"
                                                            id="searchbox_products" style="flex-grow: 1;">
                                                        </select>
                                                        <button type="button" class="btn btn-danger btn-sm deleteAll">
                                                            Hapus Semua Barang<i
                                                                class="ml-1 fas fa-trash-alt fa-xs"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card"
                                            style="border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">
                                            <div class="card-body pl-0">
                                                <div class="table-responsive">
                                                    <table class="table table-hover text-nowrap" id="table_products">
                                                        <thead>
                                                            <tr>
                                                                <th>#</th>
                                                                <th>Nama Barang</th>
                                                                <th>Harga</th>
                                                                <th>Jumlah</th>
                                                                <th>Total</th>
                                                                <th class="text-center">Hapus</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <input type="hidden" name="product_id[]" value="1">
                                                            <input type="hidden" name="quantity[]" value="2">
                                                            <input type="hidden" name="price[]" value="10000">
                                                            <input type="hidden" name="total_product[]" value="20000">
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-3 pr-0 mt-3 mt-md-0">
                                <div class="card card-secondary">
                                    <div class="card-body">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <label for="customer">Customer</label>
                                            <small><a href="#" id="btn-add-customer">tambah</a></small>
                                            <select name="customer" class="form-control" id="searchbox_customers"
                                                required>
                                                <option value="" selected disabled hidden>Select the customer</option>
                                                {% for customer in customers %}
                                                <option value="{{customer.value}}">{{customer.label}}</option>
                                                {% endfor %}
                                            </select>
                                            <div id="new-customer-fields" style="display:none;" class="mt-2">
                                                <input type="text" name="new_customer_name" class="form-control mb-2"
                                                    placeholder="Nama customer">
                                                <input type="text" name="new_customer_address" class="form-control mb-2"
                                                    placeholder="Alamat customer">
                                                <input type="text" name="new_customer_phone" class="form-control mb-2"
                                                    placeholder="Nomor telepon">
                                            </div>
                                        </div>
                                        <div class="form-group mt-4">
                                            <label>Subtotal</label>
                                            <div class="input-group">
                                                <input name="sub_total" id="sub_total" class="form-control" required>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Bayar</label>
                                            <div class="input-group">
                                                <input name="amount_payed" id="amount_payed" class="form-control"
                                                    required>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>Sisa</label>
                                            <div class="input-group">
                                                <input name="amount_change" id="amount_change" class="form-control"
                                                    readonly>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-success btn-block font-weight-bold">
                                            Create sale
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock content %}
{% block scriptcontent %}

<!--Select2-->
<script src="{% static 'assets2/vendor/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'assets2/vendor/datatables/dataTables.bootstrap4.min.js' %}"></script>
<!--Select2-->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>
<!--Bootstrap Touchspin-->
<script src="{% static 'assets2/assets/bootstrap-touchspin-master/src/jquery.bootstrap-touchspin.js' %}"></script>
<!--Sweet Alert-->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.15/dist/sweetalert2.all.min.js"></script>

<script src="{% static 'assets/js/sidebar-menu.js' %}"></script>
<script>
    $('#btn-add-customer').on('click', function (e) {
        e.preventDefault();
        $('#new-customer-fields').toggle();
        if ($('#new-customer-fields').is(':visible')) {
            $('#searchbox_customers').prop('disabled', true);
        } else {
            $('#searchbox_customers').prop('disabled', false);
        }
    });
</script>
<script>
    // Source: https://stackoverflow.com/a/32605063
    function roundTo(n, digits) {
        if (digits === undefined) {
            digits = 0;
        }

        var multiplicator = Math.pow(10, digits);
        n = parseFloat((n * multiplicator).toFixed(11));
        return Math.round(n) / multiplicator;
    }
    // function formatCurrency(amount) {
    //     return 'Rp ' + amount.toLocaleString('id-ID');
    // }
    function formatCurrency(amount) {
        let isNegative = amount < 0;
        let formattedAmount = 'Rp ' + Math.abs(amount).toLocaleString('id-ID', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        return isNegative ? '-' + formattedAmount : formattedAmount;
    }
    //Variable for product number in table
    var number = 1;

    //Variable to store sale details and products
    var sale = {
        items: {
            customer: 0,
            sub_total: 0.00,
            amount_payed: 0.00,
            amount_change: 0.00,
            products: [

            ]
        },
        calculate_sale: function () {
            // Subtotal of all products added
            var sub_total = 0.00


            // Calculates the total for each product
            $.each(this.items.products, function (pos, dict) {
                dict.pos = pos;
                dict.total_product = roundTo(dict.quantity * dict.price, 2);
                // Add the product total to the sale subtotal
                sub_total += roundTo(dict.total_product, 2);
            });

            //Update the sale subtotal, grand total, and tax amount
            this.items.sub_total = roundTo(sub_total, 2);

            $('input[name="sub_total"]').val(formatCurrency(this.items.sub_total));
        },
        // Adds a product to the sale object
        add_product: function (item) {
            this.items.products.push(item);
            this.list_product();
        },
        // Shows the selected product in the table
        list_product: function () {
            // Calculate the sale 
            this.calculate_sale();

            tblProducts = $("#table_products").DataTable({
                destroy: true,
                data: this.items.products,
                columns: [
                    { "data": "number" },
                    { "data": "name" },
                    { "data": "price" },
                    { "data": "quantity" },
                    { "data": "total_product" },
                    { "data": "id" },
                ],
                columnDefs: [
                    {
                        // Quantity
                        class: 'text-center',
                        targets: [3],
                        render: function (data, type, row) {
                            return '<input name="quantity" type="text" class="form-control form-control-xs text-center input-sm" autocomplete="off" value="' + row.quantity + '">';
                        },
                    },
                    {
                        //Product price an total
                        class: 'text-right',
                        targets: [2, 4],
                        render: function (data, type, row) {
                            return formatCurrency(parseFloat(data));
                        },
                    },
                    {
                        //Delete button
                        class: 'text-center',
                        targets: [-1],
                        orderable: false,
                        render: function (data, type, row) {
                            return '<a rel="delete" type="button" class="btn btn-sm btn-danger" data-bs-toggle="tooltip" title="Delete product"> <i class="fas fa-trash-alt fa-xs"></i> </a>';
                        },
                    },

                ],
                // rowCallback(row, data, displayNun, displayIndex, dataIndex) {
                //     $(row).find(("input[name='quantity']")).TouchSpin({
                //         min: 1,
                //         max: 10000, //MÃ¡ximo de acuerdo al stock de cada producto
                //         step: 1,
                //         decimals: 0,
                //         boostat: 1,
                //         maxboostedstep: 3,
                //         postfix: ''
                //     });
                // },
            })

            // IDs de productos ya seleccionados para exlcuir en la busqueda
            //console.log("this.traer_ids()");
            //console.log(this.traer_ids());

        },
    };

    $(document).ready(function () {


        //Select2 customers
        $('#searchbox_customers').select2({
            placeholder: "Select a customer",
            allowClear: true,
        });

        // Tables Events
        $('#table_products tbody').on('click', 'a[rel="delete"]', function () {
            // When a product is deleted

            // Row variable of the table
            var tr = tblProducts.cell($(this).closest('td, li')).index();
            product_name = (tblProducts.row(tr.row).data().name)

            Swal.fire({
                customClass: {
                    confirmButton: 'ml-3 btn btn-danger',
                    cancelButton: 'btn btn-info'
                },
                buttonsStyling: false,
                title: "Are you sure you want to delete this product from the sale?",
                text: product_name,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Delete',
                cancelButtonText: 'Cancel',
                reverseButtons: true,

            }).then((result) => {
                // Si se confirma
                if (result.isConfirmed) {

                    // Delete the product
                    sale.items.products.splice(tr.row, 1);
                    //List the table again
                    sale.list_product();
                    Swal.fire('The product was eliminated!', '', 'success')
                };
            })



        }).on('change keyup', 'input[name="quantity"]', function () {
            // When a product changes is quantity
            var quantity = parseInt($(this).val());
            //console.log(quantity);
            // Row variable of the table
            var tr = tblProducts.cell($(this).closest('td, li')).index();
            console.log(tr);
            //var data = tblProductos.row(tr.row).node();
            //console.log(data);
            // Update the product quantity in the sale object
            sale.items.products[tr.row].quantity = quantity;
            console.log(sale.items.products);
            // Calculate the sale with the new quantity
            sale.calculate_sale();
            // Find the row to update the product total
            $('td:eq(4)', tblProducts.row(tr.row).node()).html(formatCurrency(sale.items.products[tr.row].total_product));
        });

        // Delete all products
        $('.deleteAll').on('click', function () {
            // If there are no products doesn't do anything
            if (sale.items.products.length === 0) return false;
            // Alert the user
            Swal.fire({
                customClass: {
                    confirmButton: 'ml-3 btn btn-danger',
                    cancelButton: 'btn btn-info'
                },
                buttonsStyling: false,
                title: "Are you sure you want to delete all products from the sale?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Delete all',
                cancelButtonText: 'Cancel',
                reverseButtons: true,

            }).then((result) => {
                // Si se confirma
                if (result.isConfirmed) {
                    // Borramos todos los productos del objeto de venta
                    sale.items.products = [];
                    // Calculamos de vuelta la factura
                    sale.list_product();
                    Swal.fire('All products were eliminated!', '', 'success')
                };
            })
        });

        //Select2 products searchbox
        // Validate the csrf_token
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        // To avoid error 403 Fordbidden
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        $('#searchbox_products').select2({
            delay: 250,
            placeholder: 'Cari Barang',
            minimumInputLength: 1,
            allowClear: true,
            templateResult: template_product_searchbox,
            ajax: {
                url: "{% url 'products:get_products' %}",
                type: 'POST',
                data: function (params) {
                    var queryParameters = {
                        term: params.term,
                        //excluir_prod_seleccionados: JSON.stringify(venta.traer_ids())
                    }
                    return queryParameters;
                },
                processResults: function (data) {
                    console.log(data)
                    return {
                        results: data
                    };
                },
            }
        }).on('select2:select', function (e) {
            //When a product is selected from the searchbox
            var data = e.params.data;
            //Add number, subtotal and quantity of the product to the dictionary
            data.number = number;
            number++; //Increase the product number in the table
            //data.sub_total = 0;
            //data.quantity = 1;
            //Add the product to the sale object
            sale.add_product(data);
            console.log("Sale items");
            console.log(sale.items);
            //Clean the searchbox after the product is selected
            $(this).val('').trigger('change.select2');;
        });

        // Products datatable

        tblProducts = $('#table_products').DataTable({
            columnDefs: [
                {
                    targets: [-1], // column index (start from 0)
                    orderable: false, // set orderable false for selected columns
                }
            ],
        });


    });

    // Product searchbox templateResult
    function template_product_searchbox(repo) {
        if (repo.loading) {
            return repo.text;
        }

        var option = $(
            '<div class="wrapper container">' +
            ' <div class="row">' +
            '<div class="col-lg-11 text-left shadow-sm">' +
            //'<br>' +
            '<p style="margin-bottom: 5px;">' +
            '<b>Name:</b> ' + repo.text + " | Category: " + "<span class='btn-info px-2'>" + repo.category + '</span> <br>' +
            '<b>Price:</b> <span class="btn-success px-2">' + repo.price + ' $. </span>' +
            '</p>' +
            '</div>' +
            '</div>' +
            '</div>');

        return option;
    }

    // Send the sale via ajax
    function parseCurrency(value) {
        return parseFloat(value.replace(/[^,\d]/g, '').replace(',', '.'));
    }

    function roundTo(value, decimals) {
        return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
    }
    $('[name="amount_payed"], [name="sub_total"],[name="sub_total"]').on('keyup', function () {
        let currentValue = $(this).val().replace(/^Rp\s*/i, ''); // Remove existing "Rp " prefix
        let parsedValue = parseCurrency(currentValue);
        let formattedValue = formatCurrency(parsedValue);
        $(this).val(formattedValue);
        calculateAmountChange();
    });

    function calculateAmountChange() {
        let amountPayed = parseCurrency($('[name="amount_payed"]').val());
        let subTotal = parseCurrency($('[name="sub_total"]').val());
        let amountChange = roundTo(amountPayed - subTotal, 2);
        $('[name="amount_change"]').val(formatCurrency(amountChange.toString()));
    }

    $('.saleForm').on('submit', function (e) {
        e.preventDefault();

        // Only allow sending if we have at least one product
        if (sale.items.products.length === 0) {
            Swal.fire({
                title: 'The sale must have at least 1 product',
                text: 'Search a product and add it to the sale',
                icon: 'warning',
            });
            return false;
        }

        // Only allow sending if the paid amount is equal or greater than the total
        if (parseCurrency($('[name="amount_payed"]').val()) < parseCurrency($('[name="sub_total"]').val())) {
            Swal.fire({
                title: 'Payable Amount is lower than the Grand Total',
                icon: 'warning',
            });
            return false;
        }

        // Add the missing data to the sale object
        sale.items.customer = $('select[name="customer"]').val();
        if ($('#new-customer-fields').is(':visible')) {
            sale.items.new_customer_name = $('input[name="new_customer_name"]').val();
            sale.items.new_customer_address = $('input[name="new_customer_address"]').val();
            sale.items.new_customer_phone = $('input[name="new_customer_phone"]').val();
        } else {
            sale.items.new_customer_name = '';
            sale.items.new_customer_address = '';
            sale.items.new_customer_phone = '';
        }
        console.log("Customer: " + sale.items.customer);
        sale.items.sub_total = parseCurrency($('input[name="sub_total"]').val());
        sale.items.amount_payed = parseCurrency($('[name="amount_payed"]').val());
        sale.items.amount_change = roundTo(sale.items.amount_payed - sale.items.sub_total, 2);

        console.log("Sale:")
        console.log(sale.items)

        // Validate the csrf_token
        var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });
        $.ajax({
            url: "{% url 'sales:sales_add' %}",
            type: "POST",
            data: JSON.stringify(sale.items),
            contentType: "application/json",
            success: function (response) {
                if (response.success) {
                    Swal.fire('Berhasil!', response.message, 'success').then(() => {
                        window.location.href = response.redirect_url;
                    });
                } else {
                    Swal.fire('Gagal!', response.message, 'error');
                }
            }
        });


    });

</script>

{% endblock %}