{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="page-body">

    <h4>Catat Banyak Barang Masuk (Manual)</h4>

    <form method="post">
        {% csrf_token %}
        <table class="table table-bordered" id="stockin-table">
            <thead>
                <tr>
                    <th>Produk</th>
                    <th>Jumlah</th>
                    <th>Referensi</th>
                    <th>Note</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="stockin-body">
                <tr class="stockin-row">
                    <td>
                        <select name="product[]" class="form-control product-select">
                            <option value="">-- Pilih Produk --</option>
                            {% for product in products %}
                            <option value="{{ product.id }}">{{ product.sku }} - {{ product.name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td><input type="number" name="quantity[]" class="form-control quantity" min="0" step="0.01"></td>
                    <td><input type="text" name="reference[]" class="form-control reference"></td>
                    <td><input type="text" name="note[]" class="form-control note"></td>
                    <td><button type="button" class="btn btn-danger btn-remove">Hapus</button></td>
                </tr>
            </tbody>
        </table>

        <button type="button" class="btn btn-success mb-3" id="btn-add-row">Tambah Baris</button>
        <button type="submit" class="btn btn-primary mb-3">Simpan Semua</button>

        {% if errors %}
        <div class="alert alert-danger mt-2">
            <ul>
                {% for error in errors %}
                <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </form>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        function initSelect2(el) {
            $(el).select2({
                placeholder: "-- Pilih Produk --",
                ajax: {
                    url: "{% url 'product_search_api' %}",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { q: params.term };
                    },
                    processResults: function (data) {
                        return { results: data.results };
                    },
                    cache: true
                },
                width: '100%'
            });
        }

    </script>
    <script>
        $(document).ready(function () {
            

            // Tambah baris baru
            $('#btn-add-row').click(function () {
                // clone row pertama
                let firstRow = $('#stockin-body tr:first');
                let newRow = firstRow.clone();

                // reset semua input/select
                newRow.find('input').val('');
                newRow.find('select').val('');

                // tambahkan ke tbody
                $('#stockin-body').append(newRow);
            });

            // Hapus baris
            $('#stockin-body').on('click', '.btn-remove', function () {
                if ($('#stockin-body tr').length > 1) {
                    $(this).closest('tr').remove();
                }
            });

        });
    </script>
</div>
{% endblock %}